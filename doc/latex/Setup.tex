% -----------------------------------------------------------------------------
%
% Copyright (c) 2017 Sam Cox, Roberto Sommariva
%
% This file is part of the AtChem2 software package.
%
% This file is covered by the MIT license which can be found in the
% file LICENSE.md at the top level of the AtChem2 distribution.
%
% -----------------------------------------------------------------------------
\chapter{Model Setup} \label{ch:setup}

% -------------------------------------------------------------------- %
\section{Chemical Mechanism} \label{sec:mechanism}

The \textbf{chemical mechanism} is the core element of an atmospheric
chemistry box-model. In AtChem2, the mechanism file is written in
FACSIMILE format and has the extension \texttt{.fac}. The FACSIMILE
format is used to describe chemical reactions in the commercial
\href{http://www.mcpa-software.com/}{FACSIMILE Kinetic Modelling
  Software}; for historical reasons, the software and the format have
been widely used in conjunction with the MCM. The
\href{http://mcm.leeds.ac.uk/MCMv3.3.1/extract.htt}{extraction tool}
on the MCM website can generate \texttt{.fac} files directly in
FACSIMILE format.

\subsection{FACSIMILE format} \label{subsec:facsimile-format}

Chemical reactions are described in FACSIMILE format using the
following notation:

\begin{verbatim}
% k : A + B = C + D ;
\end{verbatim}

where \texttt{k} is the rate coefficient, \texttt{A} and \texttt{B}
are the reactants, \texttt{C} and \texttt{D} are the products. The
reaction starts with the \texttt{\%} character and ends with the
\texttt{;} character. Comments -- enclosed between the characters
\texttt{*} and \texttt{;} -- can be added to the mechanism, and will
be ignored by the compiler. For example:

\begin{verbatim}
* conversion of A to C with rate coefficient of 1e-4 *;
% 1E-4 : A = C ;
\end{verbatim}

The mechanism file is processed by the script \texttt{tools/build.sh},
as explained in the \hyperref[ch:execution]{Model Execution}
chapter. For the build process to work, the \texttt{.fac} file must
include four sections delimited by a single comment line, which allows
the script to recognize the beginning of each section:

\begin{itemize}
\item Generic rate coefficients
\item Complex reactions rate coefficients
\item Sum of peroxy radicals (see below)
\item Chemical Reactions
\end{itemize}

These comment lines must always be present, even though the respective
sections can be empty. A minimal \texttt{.fac} file looks like this:

\begin{verbatim}
* Generic Rate Coefficients ;

* Complex reactions ;

* Peroxy radicals. ;

RO2 =  ;

* Reaction definitions. ;

% k : A + B = C ;
\end{verbatim}

A simple chemical mechanism in FACSIMILE format -- with the first step
of the atmospheric oxidation of ethanol -- is shown below, as an
example.

\subsection{RO2 sum} \label{subsec:ro2-sum}

The sum of organic peroxy radicals (RO2) is a key component of the
Master Chemical Mechanism (see the MCM protocol papers:
\href{https://doi.org/10.1016/S1352-2310(96)00105-7}{Jenkin et al.,
  Atmos. Environ., 31, 81-104, 1997} and
\href{https://doi.org/10.5194/acp-3-161-2003}{Saunders et al., Atmos.
  Chem. Phys., 3, 161-180, 2003}). Since AtChem2 is designed primarily
to run models based upon the MCM, the \texttt{.fac} file must contain
a section with the RO2 sum. This section must be introduced by the
comment line \texttt{*\ Peroxy\ radicals.\ ;} (see above) and has the
format:

\begin{verbatim}
RO2 = RO2a + RO2b + RO2c + ... ;
\end{verbatim}

where \texttt{RO2a}, \texttt{RO2b}, \texttt{RO2c}, are the organic
peroxy radicals in the chemical mechanism. If there are no organic
peroxy radicals in the mechanism (or if the mechanism is not based
upon the MCM), the RO2 sum must be left empty, e.g.:

\begin{verbatim}
RO2 = ;
\end{verbatim}

\emph{Important}: HO2 is a peroxy radical, but it is not an organic
molecule. Therefore it should NOT be included in the RO2 sum.

The RO2 sum is automatically generated from the mechanism file during
the build process, using the list of RO2 extracted from the MCM
database. AtChem2 includes the list of all the organic peroxy radicals
in version 3.3.1 of the MCM (\texttt{mcm/peroxy-radicals\_v3.3.1}),
which is used by default. Since v1.1, lists of organic peroxy radicals
from other versions of the MCM are also included in the \texttt{mcm/}
directory: see the file \texttt{mcm/INFO.md} for instructions on how
to use previous versions of the MCM with AtChem2.

\subsection{The MCM extraction
  tool} \label{subsec:the-mcm-extraction-tool}

The MCM website provides a convenient tool which can be used to
download the whole MCM, or subsets of it, in FACSIMILE format. After
selecting the species of interest in the
\href{http://mcm.leeds.ac.uk/MCMv3.3.1/roots.htt}{MCM browser}, add
them to the \emph{Mark List}, then proceed to the
\href{http://mcm.leeds.ac.uk/MCMv3.3.1/extract.htt}{MCM extraction
  tool} and select \emph{FACSIMILE} as format. Make sure to tick the
boxes:

\begin{verbatim}
[x] Include inorganic reactions?
[x] Include generic rate coefficients?
    FACSIMILE, FORTRAN and KPP formats only
\end{verbatim}

then press the \emph{Extract} button to download the generated
\texttt{.fac} file into a directory of choice (e.g., \texttt{model/};
see the \hyperref[sec:structure]{Model Structure} section). The
mechanism can be modified with a text editor (if necessary) or
directly used in AtChem2. More information about the MCM browser and
the extractor tool can be found on the
\href{http://mcm.leeds.ac.uk}{MCM website}.

\subsection{Build Process} \label{subsec:build-process}

Atchem2 uses a Python script (\texttt{tools/mech\_converter.py},
automatically called by \texttt{tools/build.sh} during the build
process) to convert the chemical mechanism into a format that can be
read by the Fortran code.

The script generates one Fortran file, one shared library, and four
configuration files from the \texttt{*.fac} file:

\begin{itemize}
\item \textbf{mechanism.f90} contains the equations, in Fortran code,
  to calculate the rate coefficients of each reaction. By default, it
  is placed in \texttt{model/configuration/}.
\item \textbf{mechanism.so} is the compiled version of
  \texttt{mechanism.f90}. By default, it is placed in
  \texttt{model/configuration/}.
\item \textbf{mechanism.species} contains the list of chemical species
  in the mechanism. By default, it is saved in
  \texttt{model/configuration/}. The file has no header. The first
  column is the \emph{ID number} of each species, the second column is
  the name of the species:
  \begin{verbatim}
  1 O
  2 O3
  3 NO
  4 NO2
\end{verbatim}
\item \textbf{mechanism.reac} and \textbf{mechanism.prod} contain the
  reactants and the products (respectively) in each reaction of the
  mechanism. By default, it is saved in \texttt{model/configuration/}.
  The files have a 1 line header with the number of species, the
  number of reactions and the number of equations in the Generic Rate
  Coefficients and Complex Reactions sections. The first column is the
  \emph{ID number} of the reaction, the second column is the \emph{ID
    number} of the species (from \texttt{mechanism.species}) which are
  reactants/products in that reaction:
  \begin{verbatim}
  29 71 139 numberOfSpecies numberOfReactions numberOfGenericComplex
  1 1
  2 1
  3 1
  3 2
\end{verbatim}
\item \textbf{mechanism.ro2} contains the organic peroxy radicals
  (RO2). By default, it is saved in \texttt{model/configuration/}. The
  file has a comment line header (Fortran style). The first column is
  the \emph{ID number} of the peroxy radical (from
  \texttt{mechanism.species}), the second column is the name of the
  peroxy radical as Fortran comment:
  \begin{verbatim}
  ! Note that this file is generated by tools/mech_converter.py
  ! based upon the file tools/mcm_example.fac. Any manual edits to
  ! this file will be overwritten when calling tools/mech_converter.py
  23 !CH3O2
  26 !C2H5O2
  28 !IC3H7O2
  29 !NC3H7O2
\end{verbatim}
\end{itemize}

The locations of the files generated during the build process can be
modified by changing the second and the third argument of the script
\texttt{tools/build.sh}. For more information and detailed
instructions go to: \hyperref[ch:execution]{Model Execution}.

\subsection{Example mechanism
  file} \label{subsec:example-mechanism-file}

\begin{verbatim}
* ------------------------------------------------------------------- *;
* SIMPLE CHEMICAL MECHANISM                                           *;
* Chemical mechanism for ethanol - from MCM v3.3.1                    *;
* ------------------------------------------------------------------- *;
*;
* Generic Rate Coefficients ;
*;
* Complex reactions ;
*;
* Peroxy radicals. ;
RO2 = HOCH2CH2O2 ;
*;
* Reaction definitions. ;
% 3.0D-12*EXP(20/TEMP)*0.05 : C2H5OH + OH = C2H5O ;
% 3.0D-12*EXP(20/TEMP)*0.9 : C2H5OH + OH = CH3CHO + HO2 ;
% 3.0D-12*EXP(20/TEMP)*0.05 : C2H5OH + OH = HOCH2CH2O2 ;
\end{verbatim}

% -------------------------------------------------------------------- %
\section{Model Parameters} \label{sec:parameters}

The \textbf{model parameters} are set in the text file
\texttt{model/configuration/model.parameters}; they control the
general setup of the model.

\begin{itemize}
\item \textbf{number of steps} and \textbf{step size}. The duration of
  the model run is determined by the number of steps and the step size
  (in seconds). The step size controls the frequency of the model
  output for the chemical species listed in
  \texttt{outputSpecies.config} (see \hyperref[sec:config]{Config
    Files}), and for the environment variables, the photolysis rates,
  the diagnostic variables. For example, a model runtime of 2 hours,
  with output every 5 minutes, requires 24 steps with a step size of
  300 seconds (24x300 = 7200 sec = 2 hours). Possible values for these
  parameters are shown below, for reference.
\item \textbf{species interpolation method} and \textbf{conditions
    interpolation method}. Interpolation method used for the
  constrained chemical species, and for the constrained environment
  variables and the photolysis rates, respectively (see
  \hyperref[sec:constraints]{Constraints}). Two interpolation methods
  are currently implemented in AtChem2: piecewise constant
  (\texttt{1}) and piecewise linear (\texttt{2}). The default option
  is \emph{piecewise linear interpolation}.
\item \textbf{rates output step size}. Frequency (in seconds) of the
  model output for the production and loss rates of selected
  species. The species for which this parameter is required are listed
  in \texttt{outputRates.config} (see \hyperref[sec:config]{Config
    Files}).
\item \textbf{model start time}. Start time of the model (in seconds)
  calculated from midnight of the \textbf{day}, \textbf{month},
  \textbf{year} parameters (see below). For example, a start time of
  3600 means the model run starts at 1:00 in the morning and a start
  time of 43200 means the model run starts at midday. The
  \textbf{model stop time} is automatically calculated as:
  \texttt{model\ start\ time\ +\ (number\ of\ steps\ *\ step\
    size))}. \emph{Important}: if one or more variables are
  constrained, the interval between the model start time and the model
  stop time must be equal or shorter than the time interval of the
  constrained data (see \hyperref[sec:constraints]{Constraints}).
\item \textbf{jacobian output step size}. Frequency of the model
  output for the Jacobian matrix (in seconds). If the frequency is set
  to \texttt{0} (default option), the Jacobian matrix is not
  output. Note that the \texttt{jacobian.output} file generated by the
  model can be very large, especially if the chemical mechanism has
  many reactions and/or the model runtime is long.
\item \textbf{latitude} and \textbf{longitude}. Geographical
  coordinates (in degrees). By convention, latitude North is positive
  and latitude South is negative, longitude East is negative and
  longitude West is positive. Latitude and longitude are used only for
  the calculation of the Earth-Sun angles, which are needed for the
  MCM photolysis parameterisation (see
  \hyperref[sec:photolysis]{Photolysis Rates and JFAC}).
\item \textbf{day} and \textbf{month} and \textbf{year}. Start date of
  the model simulation. The model time is in seconds since midnight of
  the start date.
\item \textbf{reaction rates output step size}. Frequency (in seconds)
  of the model output for the reaction rates of every reaction in the
  chemical mechanism. The reaction rates are saved in the directory
  \texttt{model/output/reactionRates/} as one file for each model
  step, with the name of the file corresponding to the time in
  seconds. In previous versions of AtChem, this output was called
  \emph{instantaneous rates}. Note that this parameter is different
  from \textbf{rates output step size} (see above), which sets the
  frequency of a formatted output of reaction rates for selected
  species of interest. For more information go to:
  \hyperref[sec:config]{Config Files}.
\end{itemize}

\textbf{Runtime reference values}

\begin{verbatim}
96      number of steps
900     step size
\end{verbatim}

For 2 days at 15 minute intervals:

\begin{verbatim}
192     number of steps
900     step size
\end{verbatim}

For 2 days at 1 minute intervals:

\begin{verbatim}
2880    number of steps
60      step size
\end{verbatim}

% -------------------------------------------------------------------- %
\section{Solver Parameters} \label{sec:solver}

The \textbf{solver parameters} are set in the text file
\texttt{model/configuration/solver.parameters}; they control the
behaviour of the ordinary differential equations (ODE) solver. A
complete explanation of these parameters can be found in the
\href{https://computation.llnl.gov/projects/sundials/sundials-software}{CVODE
  documentation}.

\begin{itemize}
\item \textbf{atol} (positive real) and \textbf{rtol} (positive real):
  absolute and relative tolerance values for the solver. Standard
  values for these parameters are listed below, for reference.
\item \textbf{delta main} (positive real): linear convergence
  tolerance factor of the GMRES linear solver.
\item \textbf{lookback} (positive integer): maximum Krylov subspace
  dimension of the GMRES linear solver.
\item \textbf{maximum solver step size} (positive real): maximum size
  (in seconds) of the timesteps that the solver is allowed to use.
\item \textbf{maximum number of steps in solver} (positive integer):
  maximum number of steps used by the solver before reaching
  \textbf{tout}, the next output time.
\item \textbf{solver type} (integer): selects the linear solver to
  use: \texttt{1} for GMRES, \texttt{2} for GMRES preconditioned with
  a banded preconditioner, \texttt{3} for a dense solver. The default
  option is \texttt{2}.
\item \textbf{banded preconditioner upper bandwidth} (integer): used
  in the case that \texttt{solver\ type\ =\ 2}.
\item \textbf{banded preconditioner lower bandwidth} (integer): used
  in the case that \texttt{solver\ type\ =\ 2}.
\end{itemize}

\textbf{Solver reference values}

\begin{verbatim}
1.0e-04     atol
1.0e-06     rtol
\end{verbatim}

% -------------------------------------------------------------------- %
\section{Environment Variables} \label{sec:envvar}

The \textbf{environment variables} define the physical parameters of
the box-model, such as temperature, pressure, humidity, latitude,
longitude, position of the sun, etc\ldots{} These variables are set in
the text file\\
\texttt{model/configuration/environmentVariables.config}.

The environment variables can have a fixed (constant) value or can be
constrained to measured values (\texttt{CONSTRAINED}), in which case
the corresponding data file must be in the
\texttt{model/constraints/environment/} directory (see
\hyperref[sec:constraints]{Constraints}). Some environment variables
can be calculated by the model (\texttt{CALC}) and some can be
deactivated if they are not used by the model (\texttt{NOTUSED}).

By default, most environment variables are set to \texttt{NOTUSED}, or
to a fixed value, corresponding to the \emph{standard environmental
  conditions}:

\begin{verbatim}
Temperature = 25C
Pressure = 1 atm
Relative Humidity = 50%
Day, Month = 21 June
\end{verbatim}

\subsection{TEMP} \label{subsec:temp}

Ambient Temperature (K).

\begin{itemize}
\item fixed value
\item constrained
\end{itemize}

Default fixed value = 298.15

\subsection{PRESS} \label{subsec:press}

Ambient Pressure (mbar).

\begin{itemize}
\item fixed value
\item constrained
\end{itemize}

Default fixed value = 1013.25

\subsection{RH} \label{subsec:rh}

Relative Humidity (\%). It is required only if
\hyperref[subsec:h2o]{H2O} is set to \texttt{CALC}, otherwise should
be set to \texttt{NOTUSED}.

\begin{itemize}
\item fixed value
\item constrained
\item not used
\end{itemize}

Default = NOTUSED (-1)

\subsection{H2O} \label{subsec:h2o}

Water Concentration (molecules cm-3).

\begin{itemize}
\item fixed value
\item constrained
\item calculated -\textgreater{} requires \hyperref[subsec:rh]{RH} set
  to fixed value or \texttt{CONSTRAINED}
\end{itemize}

Default fixed value = 3.91e+17

\subsection{DEC} \label{subsec:dec}

Sun Declination (radians) is the angle between the center of the Sun
and Earth's equatorial plane.

\begin{itemize}
\item fixed value
\item constrained
\item calculated -\textgreater{} requires \textbf{DAY} and
  \textbf{MONTH}, which are set in \texttt{model.parameters} (see
  \hyperref[sec:parameters]{Model Parameters})
\end{itemize}

Default fixed value = 0.41

\subsection{BLHEIGHT} \label{subsec:blheight}

Boundary Layer Height. It is required only if the model includes
emission or deposition processes (it must be used in the chemical
mechanism as a multiplier of the rate coefficient). The unit is
typically in cm, but it depends on how the processes are parameterized
in the chemical mechanism (see \hyperref[sec:mechanism]{Chemical
  Mechanism}).

\begin{itemize}
\item fixed value
\item constrained
\item not used
\end{itemize}

Default = NOTUSED (-1)

\subsection{DILUTE} \label{subsec:dilute}

Dilution rate. It is required only if the model includes a dilution
process (it must be used in the chemical mechanism as a multiplier of
the rate coefficient). The unit is typically in s-1, but it depends on
how the process is parameterized in the chemical mechanism (see
\hyperref[sec:mechanism]{Chemical Mechanism}).

\begin{itemize}
\item fixed value
\item constrained
\item not used
\end{itemize}

Default value = NOTUSED (-1)

\subsection{JFAC} \label{subsec:jfac}

Correction factor used to correct the photolysis rates (e.g., to
account for cloudiness). The calculated photolysis rates are scaled by
JFAC, which can have a value between \texttt{0} (photolysis rates go
to zero) and \texttt{1} (photolysis rates are not corrected). JFAC is
NOT applied to constant or constrained photolysis rates. For more
information go to: \hyperref[sec:photolysis]{Photolysis Rates and
  JFAC}.

\begin{itemize}
\item fixed value
\item constrained
\item calculated
\end{itemize}

Default fixed value = 1

\subsection{ROOF} \label{subsec:roof}

Flag to turn the photolysis rates ON/OFF. It is used in simulations of
environmental chamber experiments, where the roof of the chamber can
be opened/closed or the lights turned on/off.

When ROOF is set to \texttt{CLOSED} all the photolysis rates are zero,
including those that are constant or constrained; this is different
than setting JFAC to \texttt{0}, which only applies to the calculated
photolysis rates (see above). ROOF is the only environment variable
that cannot be set to \texttt{CONSTRAINED}.

Default value = OPEN

% -------------------------------------------------------------------- %
\section{Photolysis rates} \label{sec:photolysis}

The photolysis rates are identified in
\hyperref[sec:mechanism]{FACSIMILE format} as
\texttt{J\textless{}n\textgreater{}}, where \texttt{n} is an integer
determined by the
\href{http://mcm.leeds.ac.uk/MCMv3.3.1/parameters/photolysis.htt}{MCM
  naming convention}. The photolysis rates are calculated by AtChem2
using the
\href{http://mcm.leeds.ac.uk/MCM/parameters/photolysis_param.htt}{MCM
  parametrization}, as explained in more detail below. Each photolysis
rate can also be set to a constant value or to constrained values.

The following rules apply:

\begin{enumerate}
\item If a photolysis rate is set as constant, it assumes the given
  value. Any other photolysis rate, without an explicitly defined
  constant value, is set to zero.
\item If one or more photolysis rates are set to constrained (and none
  is set to constant), they assume the values given in the
  corresponding constraint files. Any other photolysis rate is
  calculated.
\item If no photolysis rate is set to constant or to constrained, the
  model calculates all the photolysis rates.
\end{enumerate}

The environment variable \texttt{ROOF} can also be used to turn the
photolysis rates ON/OFF, which is useful for simulations of some
environmental chamber experiments (see
\hyperref[sec:envvar]{Environment Variables}).

\subsection{Constant photolysis
  rates} \label{subsec:constant-photolysis-rates}

The typical scenario for constant photolysis rates is the use of a
lamp in an environmental chamber. All the photolysis rates used in the
mechanism need to be given a value (in
\texttt{model/configuration/photolysisConstant.config}) otherwise they
will be set to zero. This approach allows the user to model individual
photolysis processes and/or to account for lamps that emit only in
certain spectral windows. The format of the
\texttt{photolysisConstant.config} file is described in the
\hyperref[sec:config]{Config Files} section.

\subsection{Constrained photolysis
  rates} \label{subsec:constrained-photolysis-rates}

Photolysis rates can be constrained to measured values. In this case,
the name of the constrained photolysis rate (e.g., \texttt{J2}) must
be listed in\\
\texttt{model/configuration/photolysisConstrained.config} and a
corresponding file with the constraint data must be present in
\texttt{model/constraints/photolysis/}. For more information go to:
\hyperref[sec:config]{Config Files} and
\hyperref[sec:constraints]{Constraints}.

It is not always possibile to measure -- and therefore constrain --
all the required photolysis rates. The photolysis rates that are not
constrained (i.e., not listed in
\texttt{photolysisConstrained.config}) are calculated using the MCM
parametrization.

\subsection{Calculated photolysis
  rates} \label{subsec:calculated-photolysis-rates}

AtChem2 implements the parametrization of photolysis rates used by the
Master Chemical Mechanism. It is described in the MCM protocol papers:
\href{https://doi.org/10.1016/S1352-2310(96)00105-7}{Jenkin et al.,
  Atmos. Environ., 31, 81, 1997} and
\href{https://doi.org/10.5194/acp-3-161-2003}{Saunders et al., Atmos.
  Chem. Phys., 3, 161, 2003}.

The MCM parametrization calculates the photolysis rate of a reaction
(\texttt{J}) with the equation:

\begin{verbatim}
J = l * (cosX)^m * exp(-n * secX) * tau
\end{verbatim}

where \texttt{l}, \texttt{m}, \texttt{n} are empirical parameters,
\texttt{cosX} is the cosine of the solar zenith angle, \texttt{secX}
is the inverse of \texttt{cosX} (i.e., \texttt{secX\ =\ 1/cosX}) and
\texttt{tau} is the transmission factor. The empirical parameters are
different for each version of the MCM. AtChem2 v1.1 includes the
empirical parameters for
\href{http://mcm.leeds.ac.uk/MCM/parameters/photolysis_param.htt}{version
  3.3.1} in the file \texttt{mcm/photolysis-rates\_v3.3.1}. This file
also contains the transmission factor \texttt{tau}, which can be
changed by the user (by default \texttt{tau\ =\ 1}). It is possible to
use previous versions of the MCM parametrization: see the file
\texttt{mcm/INFO.md} for instructions.

The solar zenith angle is calculated by AtChem2 using latitude,
longitude, time of the day and sun declination (see
\hyperref[sec:parameters]{Model Parameters} and
\hyperref[sec:envvar]{Environment Variables}). The calculation is
detailed in ``The Atmosphere and UV-B Radiation at Ground Level''
(\href{https://doi.org//10.1007/978-1-4899-2406-3_1}{S. Madronich,
  Environmental UV Photobiology, 1993}).

\subsection{JFAC calculation} \label{subsec:jfac-calculation}

Measurements of ambient photolysis rates typically show short-term
variability, due to the changing meteorological conditions (clouds,
rain, etc\ldots{}). This information is retained in the constrained
photolysis rates, but it is lost in the calculated ones. To account
for this, the calculated photolysis rates can be scaled by a
correction factor (\texttt{JFAC}), as explained below.

The environment variable \texttt{JFAC} is a constant or time-dependent
parameter that can be used to correct the calculated photolysis rates
for external factors not taken into account by the MCM
parametrization, such as cloudiness. \texttt{JFAC} is defined as the
ratio between a measured and the calculated photolysis rate. Typically
\texttt{J4} (the photolysis rate of NO2) is used for this purpose, as
it is one of the most frequently measured photolysis rates.

\begin{verbatim}
JFAC = j(NO2)/J4
\end{verbatim}

where \texttt{j(NO2)} is the measured value and \texttt{J4} is
calculated with the MCM parametrization (see above). \texttt{JFAC} is
by default 1, meaning that the calculated photolyis rates are not
scaled; it can be set to any value between 0 and 1 (see
\hyperref[sec:envvar]{Environment Variables}) or it can be constrained
(see \hyperref[sec:constraints]{Constraints}). Note that only the
photolysis rates calculated with the MCM parameterization are scaled
by \texttt{JFAC}, the constrained and the constant photolysis rates
are not.

\texttt{JFAC} can also be calculated at runtime. To do so,
\texttt{JFAC} should be set to the name of the photolysis rate to be
used as reference (e.g., \texttt{J4}) in\\
\texttt{model/configuration/environmentVariables.config}. There should
be an associated constraint file in
\texttt{model/constraints/environment/}. \textbf{Important}: this
option is not working very well in the current version of AtChem2, so
it is suggested to calculate \texttt{JFAC} offline and to constrain it
(see issue \href{https://github.com/AtChem/AtChem2/issues/16}{\#16}).

% -------------------------------------------------------------------- %
\section{Config Files} \label{sec:config}

The \textbf{configuration files} contain the settings for the initial
conditions, the constraints and the output of the model. These files
complement the configuration settings of the model (in
\texttt{model.parameters}) and of the solver (in
\texttt{solver.parameters}), which are in the same directory. For more
information go to: \hyperref[sec:parameters]{Model Parameters} and
\hyperref[sec:solver]{Solver Parameters}).

The configuration files have the extension \texttt{.config} and, by
default, are in the directory \texttt{model/configuration/}. This
directory also contains the files generated during the
\hyperref[subsec:build-process]{build process} which describe the
chemical mechanism (\texttt{mechanism.species},
\texttt{mechanism.reac}, \texttt{mechanism.prod},
\texttt{mechanism.ro2}), as explained in the
\hyperref[sec:mechanism]{Chemical Mechanism} page. The location of the
configuration files can be modified by changing the arguments of the
script \texttt{tools/build.sh} (see
\hyperref[subsec:build-process]{Build Process}).

The content and the format of the \texttt{.config} files are described
below. Note that the names of some files have changed with the release
of \textbf{version 1.1} (November 2018).

\subsection{environmentVariables.config} \label{subsec:environmentvariables}

This file contains the settings for the environment variables, which
are described in detail in the related
\hyperref[sec:envvar]{section}. If an environment variable is
constrained, there must be a corresponding data file in
\texttt{model/constraints/environment/} (see
\hyperref[sec:constraints]{Constraints}).

\subsection{initialConcentrations.config} \label{subsec:initialconcentrations}

This file contains the initial concentrations of the chemical species.
The first column is the list of initialized species, the second column
is the corresponding concentration at \texttt{t\ =\ 0} (in
\textbf{molecules cm-3}). For example:

\begin{verbatim}
NO      378473308.14
NO2     86893908168.9
O3      1.213e+12
CH4     4.938e+13
\end{verbatim}

The chemical species not included in this file are automatically
initialized to the default value \texttt{0}. It is not necessary to
initialize the constant and the constrained species (i.e., those
listed in \texttt{speciesConstant.config} and
\texttt{speciesConstrained.config}).

The environment variables are set in
\texttt{environmentVariables.config} (see above) and should not be
included in this file.

\subsection{outputRates.config} \label{subsec:outputrates}

This file (called \texttt{productionRatesOutput.config} and
\texttt{lossRatesOutput.config} in v1.0) lists the chemical species
for which detailed production rates and loss rates are required. The
file has one column, with one species per line.

The frequency of this output is controlled by the \textbf{rates output
  step size} parameter in \texttt{model.parameters} (see
\hyperref[sec:parameters]{Model Parameters}). The format of the
corresponding output files -- \texttt{lossRates.output} and
\texttt{productionRates.output} -- is designed to facilitate the
analysis of production and destruction rates for selected species of
interests (rather than processing the output files generated in
\texttt{model/output/reactionRates/}):

\newpage
\begin{scriptsize}
\begin{verbatim}
     time        speciesNumber    speciesName    reactionNumber         rate        reaction

3.600000E+003           8               OH              15         0.000000E+000    O1D=OH+OH
3.600000E+003           8               OH              20         0.000000E+000    HO2+O3=OH
3.600000E+003           9               HO2             16         0.000000E+000    OH+O3=HO2
3.600000E+003           9               HO2             17         0.000000E+000    OH+H2=HO2

7.200000E+003           8               OH              15         0.000000E+000    O1D=OH+OH
7.200000E+003           8               OH              20         0.000000E+000    HO2+O3=OH
7.200000E+003           9               HO2             16         0.000000E+000    OH+O3=HO2
7.200000E+003           9               HO2             17         0.000000E+000    OH+H2=HO2
\end{verbatim}
\end{scriptsize}

\subsection{outputSpecies.config} \label{subsec:outputspecies}

This file (called \texttt{concentrationOutput.config} in v1.0) lists
the chemical species for which the model output is required. The
current version of AtChem2 limits the number of species that can be
output to 100, although the user can modify the Fortran code to
increase this number. The file has one column, with one species per
line.

The frequency of this output is controlled by the \textbf{step size}
parameter in \texttt{model.parameters} (see
\hyperref[sec:parameters]{Model Parameters}).

\subsection{photolysisConstant.config} \label{subsec:photolysisconstant}

This file lists the photolysis rates that are constant. The file has
three columns: the first column is the number that identifies the
photolysis rate (e.g., \texttt{1}), the second column is the value of
the photolysis rate in \textbf{s-1} (e.g., \texttt{1e-5}), the third
column is the name of the photolysis rate (e.g., \texttt{J1}). The
photolysis rates are named according to the
\href{http://mcm.leeds.ac.uk/MCMv3.3.1/parameters/photolysis.htt}{MCM
  naming convention}. If no photolysis rate is constant, the file
should be left empty.

If one or more photolysis rates is set to a constant value, the others
(i.e., those not listed in \texttt{photolysisConstants.config}) are
set to zero. For more information go to:
\hyperref[sec:photolysis]{Photolysis Rates and JFAC}.

\subsection{photolysisConstrained.config} \label{subsec:photolysisconstrained}

This file (called \texttt{constrainedPhotoRates.config} in v1.0) lists
the photolysis rates that are constrained. The file has one column,
with one photolysis rate per line (e.g., \texttt{J1}). The photolysis
rates are named according to the
\href{http://mcm.leeds.ac.uk/MCMv3.3.1/parameters/photolysis.htt}{MCM
  naming convention}. If no photolysis rate is constrained, the file
should be left empty. If a photolysis rate is constrained, there must
be a corresponding data file in \texttt{model/constraints/photolysis/}
(see \hyperref[sec:constraints]{Constraints}).

The photolysis rates that are not listed in
\texttt{photolysisConstrained.config} are calculated by AtChem2 using
the MCM parametrization and the parameters in
\texttt{mcm/photolysis-rates\_v3.3.1}. Older versions of the MCM
photolysis parametrization can be used, as explained in the file
\texttt{mcm/INFO.md}. For more information go to:
\hyperref[sec:photolysis]{Photolysis Rates and JFAC}.

\subsection{speciesConstant.config} \label{subsec:speciesconstant}

This file (called \texttt{constrainedFixedSpecies.config} in v1.0)
lists the chemical species that are constant. The file has two
columns: the first column is the list of constant species, the second
column is the corresponding concentration (in \textbf{molecules
  cm-3}). If no chemical species is constant, the file should be left
empty.

If a chemical species is constant, it does not need to be initialized:
the values set in \texttt{speciesConstant.config} override those set
in \texttt{initialConcentrations.config}.

\subsection{speciesConstrained.config} \label{subsec:speciesconstrained}

This file (called \texttt{constrainedSpecies.config} in v1.0) lists
the chemical species that are constrained. The file has one column,
with one species per line. If no chemical species is constrained, the
file should be left empty. If a chemical species is constrained, there
must be a corresponding data file in
\texttt{model/constraints/species/} (see
\hyperref[sec:constraints]{Constraints}).

If a chemical species constrained, it does not need to be initialized:
the values set in \texttt{speciesConstrained.config} override those
set in \texttt{initialConcentrations.config}.

% -------------------------------------------------------------------- %
\section{Constraints} \label{sec:constraints}

AtChem2 can be run in two modes:

\begin{itemize}
\item unconstrained: all variables are calculated by the model from
  the initial conditions, set in the \hyperref[sec:config]{model
    configuration files}.
\item constrained: one or more variables are constrained, i.e., the
  solver forces their value to a given value. The variables that are
  not constrained are calculated by the model.
\end{itemize}

The constrained values must be provided as separate files for each
constrained variable. The format of the constraint files is described
below. By default, the files with the constraining data are in
\texttt{model/constraints/species/} for the chemical species,
\texttt{model/constraints/environment/} for the environment variables,
and \texttt{model/constraints/photolysis/} for the photolysis
rates. The default directories can be modified by changing the
arguments of the \texttt{atchem2} executable (see
\hyperref[subsec:execution]{Model Execution}).

\subsection{Constrained
  variables} \label{subsec:constrained-variables}

\subsubsection{Environment variables} \label{environment-variables}

All environment variables, except \texttt{ROOF}, can be
constrained. To do so, set the variable to \texttt{CONSTRAINED} in
\texttt{model/configuration/environmentVariables.config} and create
the file with the constraining data. The name of the file must be the
same as the name of the variable, e.g., \texttt{TEMP} (without
extension). See also: \hyperref[sec:envvar]{Environment Variables}.

\subsubsection{Chemical species} \label{chemical-species}

Any chemical species in the chemical mechanism can be constrained. To
do so, add the name of the species to
\texttt{model/configuration/speciesConstrained.config} and create the
file with the constraining data. The name of the file must be the same
as the name of the chemical species, e.g., \texttt{CH3OH} (without
extension). See also: \hyperref[sec:config]{Config Files}.

\subsubsection{Photolysis rates} \label{photolysis-rates}

Any of the photolysis rates in the chemical mechanism can be
constrained. The photolysis rates are identified as
\texttt{J\textless{}n\textgreater{}}, where \texttt{n} is an integer
(see \hyperref[sec:photolysis]{Photolysis Rates and JFAC}). To
constrain a photolysis rate add its name (\texttt{Jn}) to\\
\texttt{model/configuration/photolysisConstrained.config} and create
the file with the constraining data. The name of the file must be the
same as the name of the photolysis rate, e.g., \texttt{J4} (without
extension). See also \hyperref[sec:config]{Config Files}.

\subsection{Constraint files} \label{subsec:constraint-files}

The files with the constraining data are text files with two columns
separated by spaces. The first column is the time in \textbf{seconds}
from midnight of day/month/year (see \hyperref[sec:parameters]{Model
  Parameters}), the second column is the value of the variable in the
appropriate unit. For the chemical species the unit is
\textbf{molecules cm-3} and for the photolysis rates the unit is
\textbf{s-1}; for the environment variables see the related
\hyperref[sec:envvar]{section}. For example:

\begin{verbatim}
-900   73.21
0      74.393
900    72.973
1800   72.63
2700   72.73
3600   69.326
4500   65.822
5400   63.83
6300   64.852
7200   64.739
\end{verbatim}

The time in the first column of a constraint file can be negative.
AtChem2 interprets the negative timestamps as ``seconds \emph{before}
midnight of day/month/year'' (see \hyperref[sec:parameters]{Model
  Parameters}). This can be useful to allow correct interpolation of
the variables at the beginning of the model run (see below).

\textbf{Important.} The constraints must cover the same amount of
time, or preferably more, as the intended model runtime. For example:
if the model starts at 42300 seconds and stops at 216000 seconds, the
first and the last data points in a constraint file must have a
timestamp of 42300 (or lower) and 21600 (or higher), respectively.

\subsection{Interpolation} \label{subsec:interpolation}

Constraints can be provided at different timescales. Typically, the
constraining data come from direct measurements and it is a very
common for different instruments to sample at different
frequencies. For example, ozone and nitrogen oxides can be measured
once every minute, but most organic compounds can be measured only
once every hour.

The user can average the constraints so that they are all at the same
timescale or can use the data with the original timestamps. Both
approaches have advantages and disadvantages in terms of how much
pre-processing work is required, and in terms of model accuracy and
integration speed. Whether all the constraints have the same timescale
or not, the solver interpolates between data points using the
interpolation method selected in the
\texttt{model/configuration/model.parameters} file (see
\hyperref[sec:parameters]{Model Parameters}). The default
interpolation method is piecewise linear, but piecewise constant
interpolation is also available.

The photolysis rates and the environment variables are evaluated by
the solver when needed -- each is interpolated individually, only when
constrained. This happens each time the function
\texttt{mechanism\_rates()} is called from \texttt{FCVFUN()}, and
therefore is controlled by \textbf{CVODE} as it completes the
integration. In a similar way, the interpolation routine for the
chemical species is called once for each of the constrained species in
\texttt{FCVFUN()}, plus once when setting the initial conditions of
each of the constrained species.

As mentioned above, the model start and stop time \emph{must be}
within the time interval of the constrained data to avoid
interpolation errors or model crash. If data is not supplied for the
full runtime interval, then the \emph{final} value will be used for
all times both \emph{before the first data point} and \emph{after the
  last data point}. This behaviour is likely to change in future
versions, at least to avoid the situation where the last value is used
for all times before the first (see issue
\href{https://github.com/AtChem/AtChem2/issues/294}{\#294}).

A warning is printed for all evaluations outside of the supplied time
interval. Users may find it useful to supply data that covers a short
time \emph{beyond} the final model time, which may be used by the
solver.

% -------------------------------------------------------------------- %
\section{Tools} \label{sec:tools}

The \texttt{tools/} directory contains a number of auxiliary scripts
to install, build and compile AtChem2, and to plot the results of the
model:

\begin{itemize}
\item shell script to compile the model: \texttt{build.sh}.
\item Python scripts to process the chemical mechanism:
  \texttt{fix\_mechanism\_fac.py}, \texttt{mech\_converter.py}.
\item Python scripts to enforce a consistent
  \hyperref[sec:style]{coding style}: \texttt{fix\_indent.py},
  \texttt{fix\_style.py}.
\item Ruby script to run the unit tests: \texttt{fruit\_generator.rb}.
\item example chemical mechanism in FACSIMILE format:
  \texttt{mcm\_example.fac}.
\item \texttt{install/} directory containing scripts to install the
  \hyperref[sec:dependencies]{Dependencies}.
\item \texttt{plot/} directory containing scripts to plot the model
  results.
\end{itemize}

In addition, the \texttt{tools/} directory contains a copy of the
\texttt{Makefile}, which has to be copied to the \emph{main directory}
and modified as explained in the \hyperref[sec:install]{Installation}
section.

\subsection{Plot tools} \label{subsec:plot-tools}

The plotting scripts in \texttt{tools/plot/} are only intended to give
a quick view of the model results. It is suggested to use a proper
data analysis software (e.g., R, Octave/MATLAB, Igor, Origin,
etc\ldots{}) to process and analyze the model results. The scripts are
written in various programming languages, but they all produce the
same output: a file called \texttt{atchem2\_output.pdf} in the given
directory (e.g., \texttt{model/output/}).

From the \emph{main directory}:

\begin{verbatim}
gnuplot -c tools/plot/plot-atchem2.gp model/output/
octave tools/plot/plot-atchem2.m model/output/
python tools/plot/plot-atchem2.py model/output/
Rscript --vanilla tools/plot/plot-atchem2.r model/output/
\end{verbatim}

\emph{N.B.}: the matlab script (\texttt{plot-atchem2.m}) is compatible
with both Octave and MATLAB. GNU Octave is an open-source
implementation of MATLAB.
