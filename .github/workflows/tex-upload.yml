# -----------------------------------------------------------------------------
#
# Copyright (c) 2017 Sam Cox, Roberto Sommariva
#
# This file is part of the AtChem2 software package.
#
# This file is covered by the MIT license which can be found in the file
# LICENSE.md at the top level of the AtChem2 distribution.
#
# -----------------------------------------------------------------------------

# Workflow to upload the PDF file of the AtChem2 manual
#
# The PDF file is generated by the `tex-build.yml' worflow, which is
# triggered when the .tex/.svg files are modified
# -------------------------------------------------------------------- #

name: AtChem2 PDF upload

# ------------------------------ EVENTS ------------------------------ #
# Controls when the workflow is activated
on:

  # Run manually from the Actions tab
  workflow_dispatch:
    inputs:
      pr_branch:
        description: 'PR branch to update'
        required: true
      pdf_url:
        description: 'Artifact download URL'
        required: true

# ------------------------------ JOBS ------------------------------ #

# This workflow contains a single job called `upload_pdf_manual` which
# uses git to commit the PDF file of the
# manual to the  uploads it to the repository jobs:

  upload_pdf_manual:
    # The job runs on the latest version of linux (ubuntu), and needs
    # write permission to the repository
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:

      # -------------------------------------------------------------
      # Checkout the branch associated with the current PR
      #
      # ACTION: https://github.com/marketplace/actions/checkout
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.pr_branch }}

      # -------------------------------------------------------------
      # Push the PDF file of the manual to the current PR
      #
      # ACTION: https://github.com/marketplace/actions/upload-a-build-artifact
      - name: Download PDF artifact
        run: |
          curl -L ${{ github.event.inputs.pdf_url }} --output doc/AtChem2-Manual.pdf

      # -------------------------------------------------------------
      # Push
      - name: Add pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # configure git
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          # commit pdf file
          git add doc/AtChem2-Manual.pdf
          git commit -m "Update AtChem2-Manual.pdf"
          git push
